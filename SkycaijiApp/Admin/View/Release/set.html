<extend name="Common:main" />
<block name="cssjs">
<script type="text/javascript" src="__PUBLIC__/js/admin/release.js?{$Think.config.HTML_V}"></script>
</block>
<block name="content">
<form id="form_rele" class="form-item" method="post" ajax-submit="true" action="{:U('Release/set')}">
	<input type="hidden" name="task_id" value="{$taskData['id']}" />
	<div class="form-group">
		<div class="input-group">
			<label class="input-group-addon">{$Think.lang.rele_module}</label>
		    <select name="module" class="form-control">
				<option value="">{$Think.lang.select_first}</option>
				<foreach name="Think.config.RELEASE_MODULES" item="rele_module">
			    <option value="{$rele_module}">{:L('rele_module_'.$rele_module)}</option>
			    </foreach>
			</select>
		</div>
	</div>
	<div class="rele-module" id="rele_module_cms" module="cms" style="display:none;">
		<ul id="cms_tab" class="nav nav-tabs">
			<li class="active"><a href="#cms_tab_detect" data-toggle="tab">检测CMS程序</a></li>
			<li><a href="#cms_tab_bind" data-toggle="tab">数据绑定</a></li>
		</ul>
		<div id="cms_tab_content" class="tab-content" style="margin-top:-1px">
			<div class="tab-pane fade in active" id="cms_tab_detect">
				<div class="panel panel-default">
					<div class="panel-body">
						<div class="form-group">
							<button type="button" class="btn btn-default btn-cms-detect">{$Think.lang.rele_btn_detect}</button>
						</div>
						<div class="form-group" id="cms_list"></div>
					</div>
				</div>
			</div>
			<div class="tab-pane fade" id="cms_tab_bind">
				<div class="panel panel-default">
					<div class="panel-body">
						<div class="form-group" id="cms_info">
							<div class="input-group">
								<label class="input-group-addon"><b>{$Think.lang.rele_cms_path}</b></label>
								<input type="text" name="cms[path]" class="form-control" value="{$config['cms']['path']}" />
								<span class="input-group-btn"><button class="btn btn-default btn-cms-bind" type="button">开始绑定</button></span>
							</div>
						</div>
						<div class="form-group" id="cms_bind">
						</div>
					</div>
				</div>
			</div>
		</div>
	</div>
	<div class="rele-module" module="db" style="display:none;">
		<ul id="db_tab" class="nav nav-tabs">
			<li class="active"><a href="#db_tab_config" data-toggle="tab">数据库配置</a></li>
			<li><a href="#db_tab_table" data-toggle="tab">数据表</a></li>
		</ul>
		<div id="db_tab_content" class="tab-content" style="margin-top:-1px">
			<div class="tab-pane fade in active" id="db_tab_config">
				<div class="panel panel-default">
					<div class="panel-body">
						<div class="form-group">
					    	<label>{$Think.lang.rele_db_type}</label>
					    	<select name="db[type]" class="form-control">
								<option value="mysql">mysql</option>
							</select>
					    </div>
					    <div class="form-group">
					    	<label>{$Think.lang.rele_db_host}</label>
					    	<input name="db[host]" class="form-control" value="{$config['db']['host']?$config['db']['host']:'localhost'}">
					    </div>
					    <div class="form-group">
					    	<label>{$Think.lang.rele_db_port}</label>
					    	<input name="db[port]" class="form-control" value="{$config['db']['port']?$config['db']['port']:3306}">
					    </div>
					    <div class="form-group">
					    	<label>{$Think.lang.rele_db_charset}</label>
					    	<input name="db[charset]" class="form-control" value="{$config['db']['charset']}">
					    </div>
					    <div class="form-group">
					    	<label>{$Think.lang.rele_db_name}</label>
					    	<div class="input-group">	
					    		<input name="db[name]" class="form-control" value="{$config['db']['name']}">
	   							<div class="input-group-btn"><button type="button" class="btn btn-default btn-db-names">选择数据库</button></div>
	   						</div>
					    </div>
					    <div class="form-group">
					    	<label>{$Think.lang.rele_db_user}</label>
					    	<input name="db[user]" class="form-control" value="{$config['db']['user']}">
					    </div>
					    <div class="form-group">
					    	<label>{$Think.lang.rele_db_pwd}</label>
					    	<input type="password" name="db[pwd]" class="form-control" value="{$config['db']['pwd']}">
					    </div>
					    <div class="form-group">
					   		<button type="button" class="btn btn-default btn-db-connect">测试连接到数据库</button>
					    	<div class="rele-db-error"></div>
					    </div>
					</div>
				</div>
			</div>
			<div class="tab-pane fade" id="db_tab_table">
				<div class="panel panel-default">
			    	<div class="panel-body">
			    	<if condition="empty($releData['config']['db'])">
			    		请先保存“数据库配置”
			    	<else/>
			    		<div class="form-group">
				     		<div class="input-group db-table-list">
				     		</div>
			     		</div>
			     		<div class="form-group">
							<div class="panel-group db-table-bind" id="db_table_bind"></div>
							<p class="help-block">如需绑定自增主键，选择“自定义内容”输入“auto_id@表名”，例如“auto_id@table123”，注意：表是按顺序插入数据，前面的表不能绑定后面表的自增主键</p>
						</div>
					</if>
					</div>
			    </div>
			</div>
		</div>
	</div>
	<div class="rele-module" id="rele_module_file" module="file" style="display:none;">
		<div class="box box-default">
			<div class="box-body">
				<div class="form-group">
					<label>文件存放目录</label>
					<div class="input-group">
						<div class="input-group-addon">{:C('ROOTPATH')}\data\</div>
						<input type="text" class="form-control" name="file[path]" />
						<div class="input-group-btn">
							<button type="button" class="btn btn-default btn-file-rand-path">随机目录</button>
						</div>
					</div>
					<p class="help-block">请务必输入一个复杂的目录以防止他人破解目录下载数据！</p>
				</div>
				<div class="form-group">
					<label>文件格式</label>
					<div class="input-group">
						<label class="radio-inline">
						  <input type="radio" name="file[type]" value="xlsx"> Excel2007(.xlsx格式)
						</label>
						<label class="radio-inline">
						  <input type="radio" name="file[type]" value="xls"> Excel2003(.xls格式)
						</label>
					</div>
				</div>
			</div>
		</div>
	</div>
	<div class="rele-module" id="rele_module_api" module="api" style="display:none;">
		<div class="box box-default">
			<div class="box-body">
				<div class="form-group">
					<label>api地址</label>
					<div class="input-group">
						<div class="input-group-addon">{$api_url}</div>
						<input type="text" class="form-control" name="api[url]" />
						<div class="input-group-btn">
							<button type="button" class="btn btn-default btn-api-rand-url">随机字符串</button>
						</div>
					</div>
					<p class="help-block">
						请务必输入一个复杂的字符串以防止他人破解api下载数据！
						<if condition="!empty($releData['config']['api']['url'])">
						<a href="{$api_url}{$releData['config']['api']['url']}" target="_blank">{$api_url}{$releData['config']['api']['url']}</a>
						</if>
					</p>
				</div>
			</div>
		</div>
	</div>
	<div class="rele-module" id="rele_module_diy" module="diy" style="display:none;">
		<input type="hidden" name="diy[type]" value="app">
		<ul id="diy_tab" class="nav nav-tabs">
			<li class="active"><a href="#diy_tab_app" data-toggle="tab" data-type="app">使用插件</a></li>
			<li><a href="#diy_tab_code" data-toggle="tab" data-type="code">使用代码</a></li>
		</ul>
		<div id="diy_tab_content" class="tab-content" style="margin-top:-1px">
			<div class="tab-pane fade in active" id="diy_tab_app">
				<div class="panel panel-default">
					<div class="panel-body">
						<div class="form-group">
							<label>插件名</label>
							<input type="text" class="form-control" name="diy[app]" />
							<p class="help-block">请在网站根目录/SkycaijiApp/Release/Diy目录中创建<b></b>插件，可参考目录中的DemoDiy.class.php文件</p>
						</div>
					</div>
				</div>
			</div>
			<div class="tab-pane fade" id="diy_tab_code">
				<div class="panel panel-default">
					<div class="panel-body">
						<div class="form-group">
							<div class="table-responsive">
							<table>
							<thead>
								<tr>
									<th>数据库类型</th>
									<th>服务器</th>
									<th>库名称</th>
									<th>用户名</th>
									<th>密码</th>
									<th>端口</th>
									<th>表前缀</th>
									<th>编码</th>
								</tr>
							</thead>
							<tbody>
								<tr>
									<td>
										<select name="diy[db_type]" class="form-control">
											<option value="mysql">mysql/mysqli</option>
											<option value="sqlserver">mssql/sqlsrv</option>
											<option value="oracle">oracle</option>
											<option value="mongo">mongo</option>
											<option value="sqlite">sqlite</option>
											<option value="ibase">ibase</option>
											<option value="pgsql">pgsql</option>
											<option value="PDO">PDO</option>
										</select>
									</td>
									<td><input type="text" name="diy[db_host]" value="localhost" class="form-control" /></td>
									<td><input type="text" name="diy[db_name]" class="form-control" /></td>
									<td><input type="text" name="diy[db_user]" class="form-control" /></td>
									<td><input type="text" name="diy[db_pwd]" class="form-control" /></td>
									<td><input type="text" name="diy[db_port]" value="3306" class="form-control" /></td>
									<td><input type="text" name="diy[db_prefix]" class="form-control" /></td>
									<td><input type="text" name="diy[db_charset]" value="utf8" class="form-control" /></td>
								</tr>
							</tbody>
							</table>
							</div>
						</div>
						<div class="form-group">
							<label>PHP代码</label>
							<textarea name="diy[code]" class="form-control" rows="5"></textarea>
							<div class="help-block">
								可用变量：$fields = 采集到的字段数据列表，$url = 采集的页面网址，$this->db = 数据库操作， 可参考thinkphp3.2的数据库操作
								<br>获取字段值必须使用 $this->get_field_val($field);方法(可处理图片本地化等)，否则使用$field['value']调用字段原始值
		
		<p style="border-top:dashed 1px #ccc;padding-top:10px;margin-top:10px;">
		必须以数组形式返回：
		<br>* id（必填）表示入库返回的自增id或状态
		<br>target（可选）记录入库的数据位置（发布的网址等）
		<br>desc（可选）记录入库的数据位置附加信息
		<br>error（可选）入库的错误信息
		<br>return array('id'=>0,'target'=>'','desc'=>'','error'=>'');
		</p>
		入库的信息可在“已采集数据”中查看
							</div>
						</div>
					</div>
				</div>
			</div>
		</div>
	</div>
	<if condition="!empty($releData['config'])">
	<a href="{:U('Release/test?id='.$releData['id'])}" target="_blank" onclick="windowIframe('测试',$(this).attr('href'),{lg:1});return false;" class="btn btn-default btn-block" style="margin-bottom:10px;">测试发布（需先保存设置）</a>
	</if>
	<div class="form-group">
		<button type="submit" class="btn btn-primary btn-block">{$Think.lang.save}</button>
	</div>
</form>
<if condition="$taskData">
<include file="Task:stepsbar" />
</if>
<script type="text/javascript">
var releaseClass=new ReleaseClass('form_rele',{$releData["id"]|intval});
releaseClass.init();
<if condition="!empty($releData)">
releaseClass.load({$releData|json_encode});
</if>
</script>
</block>